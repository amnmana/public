{% extends 'pan_base.html' %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'tripapp:mypage' %}">マイページ</a></li>
        <li class="breadcrumb-item"><a href="{% url 'tripapp:tripdetails' trip_id=trip_id %}">旅行詳細</a></li>
        <li class="breadcrumb-item active" aria-current="page">必要な情報</li>
    </ol>
</nav>

<h1>必要な情報</h1>

<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>カテゴリー</th>
                <th>詳細</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for memo in memos %}
            <tr id="memo{{ memo.id }}">
                <td>{{ memo.category }}</td>
                <td>
                    <p id="detail{{ memo.id }}" style="white-space: pre-line;">{{ memo.detail }}</p>
                    <!-- 編集フォーム（デフォルトでは非表示） -->
                    <div style="display:none;" id="editForm{{ memo.id }}">
                        <textarea id="editDetail{{ memo.id }}" style="width: 100%; height: 3em;">{{ memo.detail }}</textarea>
                    </div>
                </td>
                <td>
                    <div class="button-group-inline" id="buttonGroup{{ memo.id }}">
                        <!-- 編集ボタン -->
                        <button onclick="editMemo({{ memo.id }})" id="editButton{{ memo.id }}" class="btn-flat-border">編集</button>
                        <!-- 削除ボタン -->
                        <form action="{% url 'tripapp:delete_memo' memo_id=memo.id trip_id=trip_id %}" method="post" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-flat-border btn-danger">削除</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 情報追加フォーム -->
<div class="form-container">
    <h2>情報の追加</h2>
    <form method="post" action="{% url 'tripapp:memos' trip_id=trip_id %}">
        {% csrf_token %}
        <div class="form-group">
            {{ form.as_p }}
        </div>
        <div class="button-group-centered">
            <button type="submit" class="btn-circle-border-double">登録</button>
            <button type="button" class="btn-circle-border-double" onclick="window.location.href='{% url 'tripapp:tripdetails' trip_id=trip_id %}'">戻る</button>
        </div>
    </form>
</div>

<script>
function editMemo(memoId) {
    var detailElement = document.getElementById('detail' + memoId);
    var editForm = document.getElementById('editForm' + memoId);
    var editButton = document.getElementById('editButton' + memoId);
    var saveButton = document.createElement('button');

    detailElement.style.display = 'none';
    editForm.style.display = 'block';

    saveButton.innerText = '保存';
    saveButton.className = 'btn-flat-border';
    saveButton.onclick = function() {
        saveChanges(memoId);
    };

    editButton.parentNode.replaceChild(saveButton, editButton);
}

function saveChanges(memoId) {
    var newDetail = document.getElementById('editDetail' + memoId).value;
    var csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
    var url = `{% url 'tripapp:update_memo' trip_id=trip_id %}`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `id=${memoId}&detail=${encodeURIComponent(newDetail)}`
    }).then(response => {
        if (!response.ok) {
            throw new Error(`HTTP status ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            var detailElement = document.getElementById('detail' + memoId);
            var editForm = document.getElementById('editForm' + memoId);
            var buttonGroup = document.getElementById('buttonGroup' + memoId);
            var saveButton = buttonGroup.querySelector('button');

            detailElement.innerText = newDetail;
            detailElement.style.display = 'block';
            editForm.style.display = 'none';

            // Replace the save button back to edit button
            saveButton.innerText = '編集';
            saveButton.onclick = function() {
                editMemo(memoId);
            };
        } else {
            alert('更新に失敗しました。');
        }
    }).catch(error => {
        console.error('Error:', error);
        alert('更新に失敗しました。エラーを確認してください。');
    });
}
</script>
{% endblock %}